name: Update README

on:
  schedule:
    - cron: '0 0/4 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Update this repo's README with recent activity

    steps:
      - name: Report Start Reason and Metadata
        run: |
          echo "Starter is: ${{ github.actor }};"
          echo "Repo is: ${{ github.repository }};"
          echo "Trigger is: ${{ github.eventname }};"
          echo "Job is: ${{ github.job }};"
          echo "Job id is: ${{ github.run_id }};"
      - name: Checkout
        uses: actions/checkout@v2
      - name: Load Recent Acivities
        uses: jamesgeorge007/github-activity-readme@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          COMMIT_MSG: 'Update my README via GitHub Actions'
          MAX_LINES: 10
      - name: Generate the Snake
        uses: Platane/snk@master
        id: snake-gif
        with: 
          github_user_name: Guleixibian2009
          svg_out_path: ./dist/github-snake.svg
      - name: Push to GitHub
        uses: endbug/add-and-commit@v7.2.1
        with:
          branch: master
          message: 'Daily Generate Snake' 
      - name: Report job status
        id: report
        run: |
          echo "Status: ${{ job.status }}"
          echo "::set-output name=status::${{ job.status }}"
    outputs: 
      build_status: ${{ steps.report.outputs.status }} 
  record:
    runs-on: ubuntu-latest
    name: Record Status to my Issue
    needs: build
    
    steps:
      - name: Get Data
        run: |
          date=`date +%Y%m%d`
          current=`date`
          origin=20220427
          currentTimestamp=$((`date -d "$current" +%s`*1000+`date "+%N"`))
          originTimestamp=$((`date -d "$origin" +%s`*1000+`date "+%N"`))
          timegap=$(($(( $currentTimestamp - $originTimestamp )) / 86400000))
          echo $timegap
          output="Today is ${date} , day ${timegap}. Todays build status is ${{ needs.build.outputs.build_status }}! Keep working hard, Guleixibian2009!"
          echo $output
      - name: Write to issue
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.METRICS_TOKEN }}
          issue-number: 2
          body: |
            ${output}
            
